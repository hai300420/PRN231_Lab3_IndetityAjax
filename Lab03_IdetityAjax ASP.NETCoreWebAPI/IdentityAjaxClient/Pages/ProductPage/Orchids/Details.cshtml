@page "{id:int}"
@model IdentityAjaxClient.Pages.ProductPage.Orchids.DetailsModel
@{
    ViewData["Title"] = "Orchid Details";
}

<div class="container py-5">
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger shadow-sm">
            <strong>Error:</strong> @Model.ErrorMessage
        </div>
    }
    else if (!Model.IsProductLoaded)
    {
        <div class="alert alert-info shadow-sm">
            <i class="bi bi-info-circle me-2"></i> Loading product details...
        </div>
    }
    else
    {
        <div class="card shadow-lg p-4">
            <div class="row g-5">
                <div class="col-lg-6 text-center">
                    @if (!string.IsNullOrEmpty(Model.Product.ProductUrl))
                    {
                        <img src="@Model.Product.ProductUrl" alt="@Model.Product.ProductName"
                             class="img-fluid rounded-4 shadow product-image" />
                    }
                    else
                    {
                        <div class="bg-light d-flex justify-content-center align-items-center rounded" style="height: 350px;">
                            <span class="text-muted">No image available</span>
                        </div>
                    }
                </div>
                <div class="col-md-6 d-flex flex-column justify-content-center">
                    <h2 class="fw-bold">@Model.Product.ProductName</h2>
                    <p class="text-muted">@Model.Product.CategoryName</p>

                    <h4 class="text-danger fw-bold">@Model.Product.UnitPrice.ToString("C", new System.Globalization.CultureInfo("en-US"))</h4>

                    <p class="mb-3"><strong>Type:</strong> @(Model.Product.IsNatural == true ? "Natural" : Model.Product.IsNatural == false ? "Hybrid" : "Unknown")</p>

                    @if (Model.IsCustomer)
                    {
                        <form id="addToCartForm" method="post" asp-page-handler="AddToCart">
                            <input type="hidden" name="orchidId" value="@Model.Product.ProductId" />
                            <div class="mb-3">
                                <label class="form-label"><strong>Quantity</strong></label>
                                <div class="d-flex gap-2 align-items-center">
                                    <button type="button" class="btn btn-outline-secondary" onclick="decreaseQuantity()">−</button>
                                    <input type="number" id="quantity" name="quantity" class="form-control text-center" value="1" min="1" max="10" style="max-width: 80px;">
                                    <button type="button" class="btn btn-outline-secondary" onclick="increaseQuantity()">+</button>
                                </div>
                            </div>
                            <div class="mb-4">
                                <button type="submit" id="addToCartBtn" class="btn btn-lg w-100 text-white" style="background: linear-gradient(to right, #8e2de2, #4a00e0);">
                                    <i class="bi bi-cart-plus me-2"></i> Add to Cart
                                </button>
                            </div>
                        </form>
                    }

                    <a asp-page="/Index" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i> Browse More Orchids
                    </a>
                </div>

            </div>
        </div>
    }
</div>

<form id="antiforgery" method="post">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        function increaseQuantity() {
            var input = document.getElementById('quantity');
            var value = parseInt(input.value, 10);
            if (value < parseInt(input.max)) {
                input.value = value + 1;
            }
        }

        function decreaseQuantity() {
            var input = document.getElementById('quantity');
            var value = parseInt(input.value, 10);
            if (value > parseInt(input.min)) {
                input.value = value - 1;
            }
        }

        // Add to cart AJAX functionality
        document.addEventListener('DOMContentLoaded', function() {
            const addToCartForm = document.getElementById('addToCartForm');

            if (addToCartForm) {
                addToCartForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const orchidId = this.querySelector('input[name="orchidId"]').value;
                    const quantity = document.getElementById('quantity').value;

                    const form = new FormData();
                    form.append('orchidId', orchidId);
                    form.append('quantity', quantity);

                    // Show loading state
                    const submitBtn = document.getElementById('addToCartBtn');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...';

                    // Get the anti-forgery token
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                    fetch('?handler=AddToCart', {
                        method: 'POST',
                        body: form,
                        headers: {
                            'RequestVerificationToken': token
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Reset button
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;

                        // Show toast notification
                        if (data.success) {
                            ToastManager.success(data.message || 'Item added to cart successfully!');
                        } else {
                            ToastManager.error(data.message || 'Failed to add item to cart.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        ToastManager.error('An error occurred while adding to cart.');
                    });
                });
            }
        });
    </script>
}

<style>
    .product-image {
        transition: transform 0.3s ease;
    }

        .product-image:hover {
            transform: scale(1.05);
        }

    .quantity-input-wrapper input[type="number"] {
        max-width: 80px;
        border-radius: 0;
    }

    .quantity-input-wrapper .btn {
        border-radius: 0;
    }

    .btn-lg {
        font-size: 1.1rem;
    }

    .display-6 {
        font-weight: 600;
    }
</style>
